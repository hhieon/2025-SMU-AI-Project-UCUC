{% extends "travel/base.html" %}
{% block title %}Planner{% endblock %}
{% block content %}

<!-- FullCalendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<h1 class="text-2xl font-semibold mb-4">📅 날짜별 여행 계획 자동 입력</h1>

<!-- ✅ 3열: 360px / 1fr / 560px -->
<div class="grid gap-6 lg:grid-cols-[360px_minmax(0,1fr)_560px]">

  <!-- 좌측: 입력 폼 -->
  <form method="post" class="bg-white rounded-2xl shadow p-5 space-y-4">{% csrf_token %}
    <div>
      <label class="block text-sm font-medium mb-1">도시</label>
      <input name="city" value="Seoul" class="input" />
    </div>

    <div>
      <label class="block text-sm font-medium mb-1">시작일</label>
      <input type="date" name="start_date" required class="input" />
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">일수</label>
        <input type="number" name="n_days" value="4" min="1" max="21" class="input" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">강도</label>
        <select name="intensity" class="input">
          <option>느긋</option><option selected>보통</option><option>빡빡</option>
        </select>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium mb-1">요청/메모</label>
      <textarea name="notes" rows="4" class="input" placeholder="미식/카페/야경/아이 동반 등"></textarea>
    </div>

    <!-- 모델 선택 -->
    <div>
      <label class="block text-sm font-medium mb-1">모델 제공사</label>
      <select id="provider" name="provider" class="input">
        <option value="openai" {% if provider == "openai" or not provider %}selected{% endif %}>OpenAI</option>
        <option value="gemini" {% if provider == "gemini" %}selected{% endif %}>Google Gemini</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">세부 모델</label>
      <select id="model" name="model" class="input"></select>
      <small class="muted">계정/시점에 따라 일부 모델은 미지원일 수 있어요.</small>
    </div>

    <button class="btn-primary w-full">계획 생성</button>
  </form>

  <!-- 가운데: 결과 패널 -->
  <section class="space-y-4 max-w-[780px]" id="planner-result">

    {% if weather %}
      <div class="bg-white rounded-2xl shadow p-4 flex items-center gap-4">
        <img src="{{ weather.icon_url }}" alt="{{ weather.desc }}" class="w-12 h-12">
        <div>
          <div class="font-semibold">{{ weather.name }} 오늘 날씨</div>
          <div class="text-sm text-slate-600">
            {{ weather.desc }} · {{ weather.temp|floatformat:0 }}°C
            (체감 {{ weather.feels_like|floatformat:0 }}°)
          </div>
        </div>
        <div class="ml-auto text-sm text-slate-500">
          습도 {{ weather.humidity }}% · 바람 {{ weather.wind }} m/s
        </div>
      </div>
    {% elif weather_error %}
      <div class="bg-amber-50 text-amber-800 border border-amber-200 rounded-xl p-3 text-sm">
        날씨 정보를 가져오지 못했습니다. {{ weather_error }}
      </div>
    {% endif %}

    {% if error %}
      <div class="bg-red-50 text-red-700 border border-red-200 rounded-xl p-4">
        <div class="font-semibold">오류</div>
        <div class="text-sm mt-1">{{ error }}</div>
      </div>
      {% if raw %}<pre class="codeblock mt-2">{{ raw }}</pre>{% endif %}
    {% endif %}

    {% if result %}
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-semibold">{{ result }}</h3>
      </div>

      {% if table_rows %}
        <div class="bg-white rounded-2xl shadow p-5 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-600">
              <tr><th>날짜</th><th>제목</th><th>장소</th><th>메모</th></tr>
            </thead>
            <tbody class="divide-y">
              {% for r in table_rows %}
                <tr class="hover:bg-slate-50">
                  <td class="py-2">{{ r.date }}</td>
                  <td>{{ r.title }}</td>
                  <td>{{ r.location }}</td>
                  <td class="max-w-[30rem]">{{ r.notes }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <form method="post" action="/planner/ics/" class="bg-white rounded-2xl shadow p-5">
          {% csrf_token %}
          <button class="btn-secondary">📆 ICS 다운로드</button>
        </form>
      {% endif %}
    {% else %}
      <div class="bg-white rounded-2xl shadow p-10 text-center text-slate-500">
        왼쪽에서 여행 정보를 입력하고 <b>계획 생성</b>을 눌러주세요.
      </div>
    {% endif %}
  </section>

  <!-- 오른쪽: 달력 -->
  <aside class="space-y-3">
    <div id="planner-cal" class="bg-white rounded-2xl shadow w-full" style="height:760px"></div>

    <div class="bg-white rounded-2xl shadow p-5">
      <button id="save-cal" type="button" class="btn-secondary w-full">💾 달력 내용 저장</button>
      <p class="text-xs text-slate-500 mt-2">드래그/리사이즈 시 자동 저장됩니다. 수동 저장도 가능해요.</p>
    </div>
  </aside>
</div>

<!-- 스크립트 -->
<script>
  const SELECTED = { provider: "{{ provider|default:'openai' }}", model: "{{ model|default:'' }}" };
  const MODEL_CATALOG = {
    openai: ["gpt-4o-mini","gpt-4.1-mini","gpt-4.1","gpt-4o","gpt-5"],
    gemini: ["gemini-1.5-flash","gemini-1.5-pro","gemini-1.5-flash-8b"]
  };
  function fillModels(){
    const prov = document.getElementById('provider').value;
    const s = document.getElementById('model');
    const list = MODEL_CATALOG[prov] || [];
    s.innerHTML = "";
    list.forEach(m=>{
      const o=document.createElement('option'); o.value=m; o.textContent=m;
      if(SELECTED.provider===prov && SELECTED.model===m) o.selected=true;
      s.appendChild(o);
    });
    if(!s.value && list.length) s.value=list[0];
  }
  document.getElementById('provider')?.addEventListener('change', ()=>{ SELECTED.model=""; fillModels(); });
  fillModels();

  window.initialEvents = [
    {% if table_rows %}
      {% for r in table_rows %}
      { title:"{{ r.title|escapejs }}",
        start:"{{ r.start_dt|date:'c' }}",
        end:"{{ r.end_dt|date:'c' }}",
        extendedProps:{ location:"{{ r.location|escapejs }}", notes:"{{ r.notes|escapejs }}" } }
      {% if not forloop.last %},{% endif %}
      {% endfor %}
    {% endif %}
  ];

  document.addEventListener('DOMContentLoaded', ()=>{
    const el = document.getElementById('planner-cal');
    if(!el) return;

    const initial = "{{ cal_start|default:'' }}";
    const initialDate = initial || new Date().toISOString().slice(0,10);

    el.style.height = '760px';

    // ✅ 전역 변수로 선언
    window.cal = new FullCalendar.Calendar(el, {
      initialDate,
      initialView: 'timeGridWeek',
      headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
      selectable: true,
      editable: true,
      eventStartEditable: true,
      eventDurationEditable: true,
      eventResizableFromStart: true,
      height: 760,
      expandRows: true,
      slotMinTime: '06:00:00',
      slotMaxTime: '23:00:00',
      events: window.initialEvents || [],

      select(info){
        const t = prompt('일정 제목을 입력하세요');
        if(t){ window.cal.addEvent({ title:t, start:info.startStr, end:info.endStr }); saveToServer(); }
        window.cal.unselect();
      },
      eventClick(info){
        const t = prompt('제목 수정(빈칸→삭제)', info.event.title);
        if(t===null) return;
        if(t.trim()===''){ info.event.remove(); saveToServer(); }
        else{ info.event.setProp('title', t.trim()); saveToServer(); }
      },
      eventDrop(){ saveToServer(); },
      eventResize(){ saveToServer(); }
    });
    window.cal.render();

    const debounce = (fn, ms=150)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } };
    window.addEventListener('resize', debounce(()=> window.cal.updateSize(), 150));

    function csrf(){
      const el = document.querySelector('input[name=csrfmiddlewaretoken]');
      return el ? el.value : '';
    }
    async function saveToServer(){
      const payload = {
        events: window.cal.getEvents().map(e=>({
          title: e.title,
          start: e.start ? e.start.toISOString().slice(0,19) : null,
          end:   e.end   ? e.end.toISOString().slice(0,19)   : (e.start ? e.start.toISOString().slice(0,19) : null),
          location: e.extendedProps?.location || '',
          notes:    e.extendedProps?.notes || ''
        }))
      };
      try{
        const r = await fetch('/planner/save/', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrf() },
          body: JSON.stringify(payload)
        });
        await r.json();
      }catch(err){ console.error('달력 저장 실패:', err); }
    }

    document.getElementById('save-cal')?.addEventListener('click', saveToServer);
  });

  // ✅ 챗봇 후속 결과 반영용
  function updatePlannerUI(data){
    const box = document.getElementById("planner-result");
    if(!box) return;

    // 테이블 갱신
    if(data.days){
      let html = `<div class="bg-white rounded-2xl shadow p-5"><h3 class="font-semibold">챗봇이 수정한 일정</h3></div>`;
      html += `<div class="bg-white rounded-2xl shadow p-5 overflow-auto"><table class="min-w-full text-sm"><thead class="text-left text-slate-600"><tr><th>Day</th><th>시작</th><th>종료</th><th>제목</th><th>장소</th><th>메모</th></tr></thead><tbody class="divide-y">`;
      data.days.forEach(day=>{
        day.items.forEach(it=>{
          html += `<tr class="hover:bg-slate-50"><td class="py-2">Day ${day.day}</td><td>${it.start||""}</td><td>${it.end||""}</td><td>${it.title||""}</td><td>${it.location||""}</td><td>${it.notes||""}</td></tr>`;
        });
      });
      html += `</tbody></table></div>`;
      box.innerHTML = html;

      // ✅ FullCalendar 갱신
      if(window.cal){
        window.cal.removeAllEvents();
        data.days.forEach(day=>{
          day.items.forEach(it=>{
            if(it.start && it.end){
              const baseDate = new Date(window.initialEvents?.[0]?.start || new Date());
              const d0 = new Date(baseDate);
              d0.setDate(d0.getDate() + (day.day-1));

              const start = new Date(d0.toISOString().split("T")[0] + "T" + (it.start || "09:00"));
              const end   = new Date(d0.toISOString().split("T")[0] + "T" + (it.end   || "10:00"));

              window.cal.addEvent({
                title: it.title || "",
                start: start.toISOString(),
                end:   end.toISOString(),
                extendedProps: {
                  location: it.location || "",
                  notes: it.notes || ""
                }
              });
            }
          });
        });
        window.cal.render();
      }
    }else{
      box.innerHTML = `<pre class="codeblock mt-3">${JSON.stringify(data,null,2)}</pre>`;
    }
  }
</script>
{% endblock %}
