{% extends "travel/base.html" %}
{% block title %}Planner{% endblock %}
{% block content %}

<!-- FullCalendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<h1 class="text-2xl font-semibold mb-4">ğŸ“… ë‚ ì§œë³„ ì—¬í–‰ ê³„íš ìë™ ì…ë ¥</h1>

<!-- âœ… 3ì—´: 360px / 1fr / 560px -->
<div class="grid gap-6 lg:grid-cols-[360px_minmax(0,1fr)_560px]">

  <!-- ì¢Œì¸¡: ì…ë ¥ í¼ -->
  <form method="post" class="bg-white rounded-2xl shadow p-5 space-y-4">{% csrf_token %}
    <div>
      <label class="block text-sm font-medium mb-1">ë„ì‹œ</label>
      <input name="city" value="Seoul" class="input" />
    </div>

    <div>
      <label class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
      <input type="date" name="start_date" required class="input" />
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">ì¼ìˆ˜</label>
        <input type="number" name="n_days" value="4" min="1" max="21" class="input" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">ê°•ë„</label>
        <select name="intensity" class="input">
          <option>ëŠê¸‹</option><option selected>ë³´í†µ</option><option>ë¹¡ë¹¡</option>
        </select>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium mb-1">ìš”ì²­/ë©”ëª¨</label>
      <textarea name="notes" rows="4" class="input" placeholder="ë¯¸ì‹/ì¹´í˜/ì•¼ê²½/ì•„ì´ ë™ë°˜ ë“±"></textarea>
    </div>

    <!-- ëª¨ë¸ ì„ íƒ -->
    <div>
      <label class="block text-sm font-medium mb-1">ëª¨ë¸ ì œê³µì‚¬</label>
      <select id="provider" name="provider" class="input">
        <option value="openai" {% if provider == "openai" or not provider %}selected{% endif %}>OpenAI</option>
        <option value="gemini" {% if provider == "gemini" %}selected{% endif %}>Google Gemini</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">ì„¸ë¶€ ëª¨ë¸</label>
      <select id="model" name="model" class="input"></select>
      <small class="muted">ê³„ì •/ì‹œì ì— ë”°ë¼ ì¼ë¶€ ëª¨ë¸ì€ ë¯¸ì§€ì›ì¼ ìˆ˜ ìˆì–´ìš”.</small>
    </div>

    <button class="btn-primary w-full">ê³„íš ìƒì„±</button>
  </form>

  <!-- ê°€ìš´ë°: ê²°ê³¼ íŒ¨ë„(ì‚´ì§ ì¢í˜) -->
  <section class="space-y-4 max-w-[780px]">

    {# âœ… ë‚ ì”¨ ì¹´ë“œ (POST í›„ ë³´ì—¬ì¤Œ) #}
    {% if weather %}
      <div class="bg-white rounded-2xl shadow p-4 flex items-center gap-4">
        <img src="{{ weather.icon_url }}" alt="{{ weather.desc }}" class="w-12 h-12">
        <div>
          <div class="font-semibold">{{ weather.name }} ì˜¤ëŠ˜ ë‚ ì”¨</div>
          <div class="text-sm text-slate-600">
            {{ weather.desc }} Â· {{ weather.temp|floatformat:0 }}Â°C
            (ì²´ê° {{ weather.feels_like|floatformat:0 }}Â°)
          </div>
        </div>
        <div class="ml-auto text-sm text-slate-500">
          ìŠµë„ {{ weather.humidity }}% Â· ë°”ëŒ {{ weather.wind }} m/s
        </div>
      </div>
    {% elif weather_error %}
      <div class="bg-amber-50 text-amber-800 border border-amber-200 rounded-xl p-3 text-sm">
        ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. {{ weather_error }}
      </div>
    {% endif %}

    {% if error %}
      <div class="bg-red-50 text-red-700 border border-red-200 rounded-xl p-4">
        <div class="font-semibold">ì˜¤ë¥˜</div>
        <div class="text-sm mt-1">{{ error }}</div>
      </div>
      {% if raw %}<pre class="codeblock mt-2">{{ raw }}</pre>{% endif %}
    {% endif %}

    {% if result %}
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-semibold">{{ result }}</h3>
      </div>

      {% if table_rows %}
        <div class="bg-white rounded-2xl shadow p-5 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-600">
              <tr><th>ë‚ ì§œ</th><th>ì œëª©</th><th>ì¥ì†Œ</th><th>ë©”ëª¨</th></tr>
            </thead>
            <tbody class="divide-y">
              {% for r in table_rows %}
                <tr class="hover:bg-slate-50">
                  <td class="py-2">{{ r.date }}</td>
                  <td>{{ r.title }}</td>
                  <td>{{ r.location }}</td>
                  <td class="max-w-[30rem]">{{ r.notes }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <form method="post" action="/planner/ics/" class="bg-white rounded-2xl shadow p-5">
          {% csrf_token %}
          <button class="btn-secondary">ğŸ“† ICS ë‹¤ìš´ë¡œë“œ</button>
        </form>
      {% endif %}
    {% else %}
      <div class="bg-white rounded-2xl shadow p-10 text-center text-slate-500">
        ì™¼ìª½ì—ì„œ ì—¬í–‰ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  <b>ê³„íš ìƒì„±</b>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
    {% endif %}
  </section>

  <!-- ì˜¤ë¥¸ìª½: ë‹¬ë ¥ (ë„“ê²Œ + ê³ ì • ë†’ì´) -->
  <aside class="space-y-3">
    <div id="planner-cal" class="bg-white rounded-2xl shadow w-full" style="height:760px"></div>

    <div class="bg-white rounded-2xl shadow p-5">
      <button id="save-cal" type="button" class="btn-secondary w-full">ğŸ’¾ ë‹¬ë ¥ ë‚´ìš© ì €ì¥</button>
      <p class="text-xs text-slate-500 mt-2">ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìë™ ì €ì¥ë©ë‹ˆë‹¤. ìˆ˜ë™ ì €ì¥ë„ ê°€ëŠ¥í•´ìš”.</p>
    </div>
  </aside>
</div>

<!-- ìŠ¤í¬ë¦½íŠ¸(ëª¨ë¸ ì…€ë ‰íŠ¸ + ìº˜ë¦°ë” ì´ˆê¸°í™”) -->
<script>
  /* ëª¨ë¸ ì…€ë ‰íŠ¸ */
  const SELECTED = { provider: "{{ provider|default:'openai' }}", model: "{{ model|default:'' }}" };
  const MODEL_CATALOG = {
    openai: ["gpt-4o-mini","gpt-4.1-mini","gpt-4.1","gpt-4o","gpt-5"],
    gemini: ["gemini-1.5-flash","gemini-1.5-pro","gemini-1.5-flash-8b"]
  };
  function fillModels(){
    const prov = document.getElementById('provider').value;
    const s = document.getElementById('model');
    const list = MODEL_CATALOG[prov] || [];
    s.innerHTML = "";
    list.forEach(m=>{
      const o=document.createElement('option'); o.value=m; o.textContent=m;
      if(SELECTED.provider===prov && SELECTED.model===m) o.selected=true;
      s.appendChild(o);
    });
    if(!s.value && list.length) s.value=list[0];
  }
  document.getElementById('provider')?.addEventListener('change', ()=>{ SELECTED.model=""; fillModels(); });
  fillModels();

  /* ì„œë²„ ìƒì„± ê²°ê³¼ â†’ ì´ˆê¸° ë‹¬ë ¥ ì´ë²¤íŠ¸ */
  window.initialEvents = [
    {% if table_rows %}
      {% for r in table_rows %}
      { title:"{{ r.title|escapejs }}",
        start:"{{ r.start_dt|date:'c' }}",
        end:"{{ r.end_dt|date:'c' }}",
        extendedProps:{ location:"{{ r.location|escapejs }}", notes:"{{ r.notes|escapejs }}" } }
      {% if not forloop.last %},{% endif %}
      {% endfor %}
    {% endif %}
  ];

  document.addEventListener('DOMContentLoaded', ()=>{
    const el = document.getElementById('planner-cal');
    if(!el) return;

    const initial = "{{ cal_start|default:'' }}";
    const initialDate = initial || new Date().toISOString().slice(0,10);

    // ë†’ì´ ê³ ì •(ë¬´í•œ ë¦¬ì‚¬ì´ì¦ˆ ë°©ì§€)
    el.style.height = '760px';

    const cal = new FullCalendar.Calendar(el, {
      initialDate,
      initialView: 'timeGridWeek',
      headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
      selectable: true,
      selectMirror: true,

      /* âœ… ë“œë˜ê·¸ & ë¦¬ì‚¬ì´ì¦ˆ */
      editable: true,
      eventStartEditable: true,
      eventDurationEditable: true,
      eventResizableFromStart: true,

      height: 760,
      expandRows: true,
      slotMinTime: '06:00:00',
      slotMaxTime: '23:00:00',
      events: window.initialEvents || [],

      select(info){
        const t = prompt('ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
        if(t){ cal.addEvent({ title:t, start:info.startStr, end:info.endStr }); saveToServer(); }
        cal.unselect();
      },
      eventClick(info){
        const t = prompt('ì œëª© ìˆ˜ì •(ë¹ˆì¹¸â†’ì‚­ì œ)', info.event.title);
        if(t===null) return;
        if(t.trim()===''){ info.event.remove(); saveToServer(); }
        else{ info.event.setProp('title', t.trim()); saveToServer(); }
      },
      eventDrop(){ saveToServer(); },      // âœ… ë“œë˜ê·¸ë¡œ ë‚ ì§œ/ì‹œê°„ ì´ë™
      eventResize(){ saveToServer(); }     // âœ… ê¸¸ì´ ë¦¬ì‚¬ì´ì¦ˆ
    });
    cal.render();

    // ë””ë°”ìš´ìŠ¤ëœ resizeë§Œ ì‚¬ìš©
    const debounce = (fn, ms=150)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } };
    window.addEventListener('resize', debounce(()=> cal.updateSize(), 150));

    // ê³µí†µ ì €ì¥ í•¨ìˆ˜
    function csrf(){
      const el = document.querySelector('input[name=csrfmiddlewaretoken]');
      return el ? el.value : '';
    }
    async function saveToServer(){
      const payload = {
        events: cal.getEvents().map(e=>({
          title: e.title,
          start: e.start ? e.start.toISOString().slice(0,19) : null,
          end:   e.end   ? e.end.toISOString().slice(0,19)   : (e.start ? e.start.toISOString().slice(0,19) : null),
          location: e.extendedProps?.location || '',
          notes:    e.extendedProps?.notes || ''
        }))
      };
      try{
        const r = await fetch('/planner/save/', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrf() },
          body: JSON.stringify(payload)
        });
        await r.json(); // {ok:true,count:n}
        // console.log('saved', d);
      }catch(err){ console.error('ë‹¬ë ¥ ì €ì¥ ì‹¤íŒ¨:', err); }
    }

    document.getElementById('save-cal')?.addEventListener('click', saveToServer);
  });
</script>
{% endblock %}
