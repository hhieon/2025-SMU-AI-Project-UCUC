{% extends "travel/base.html" %}
{% block content %}

<div class="diary-header flex justify-between items-center mb-4">
  <h2>ğŸ“” ë‚´ ì¼ê¸°ì¥</h2>
  <div class="flex gap-2">
    <button id="selectBtn" type="button" class="btn-select bg-amber-500 text-white px-3 py-1 rounded">
      ì„ íƒ
    </button>
    <a href="{% url 'diary_create' %}" class="btn-add bg-green-500 text-white px-3 py-1 rounded">
      ìƒˆ ì¼ê¸° +
    </a>
  </div>
</div>

<form method="post" action="{% url 'diary_delete' %}">
  {% csrf_token %}
<ul class="diary-list space-y-3">
  {% for d in diaries %}
    <li class="border-b pb-2 flex items-center gap-2">
      <input type="checkbox" name="selected" value="{{ d.id }}" class="selectBox hidden">
      <div class="diary-content flex-1">
        <a href="{% url 'diary_detail' d.id %}" class="diary-title font-semibold text-blue-600 hover:underline">
          {{ d.title }}
        </a>
        {% if d.mood_emoji %}
          <span class="ml-2 text-lg">{{ d.mood_emoji }}</span>
          <!-- âœ… ëª©ë¡ì—ì„œë„ ì´ëª¨ì§€ ìˆ˜ì • ë²„íŠ¼ -->
          <button type="button"
                  onclick="fixEmoji({{ d.id }})"
                  class="ml-1 text-xs px-2 py-1 bg-indigo-50 text-indigo-700 rounded">
            ìˆ˜ì •
          </button>
        {% endif %}
        <p class="text-gray-600 text-sm">{{ d.content|truncatewords:20 }}</p>
      </div>
    </li>
  {% empty %}
    <li>ì•„ì§ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. "ìƒˆ ì¼ê¸° +" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆ ì¼ê¸°ë¥¼ ì‘ì„±í•´ ë³´ì„¸ìš”.</li>
  {% endfor %}
</ul>

  <button type="submit" id="deleteBtn"
          class="btn-delete hidden bg-red-500 text-white px-4 py-2 rounded mt-3">
    ì„ íƒ í•­ëª© ì‚­ì œ
  </button>
</form>

<script>
let selectionMode = false;
const selectBtn = document.getElementById("selectBtn");
const checkboxes = document.querySelectorAll(".selectBox");
const deleteBtn = document.getElementById("deleteBtn");

selectBtn.addEventListener("click", () => {
  selectionMode = !selectionMode;
  checkboxes.forEach(cb => cb.classList.toggle("hidden", !selectionMode));
  deleteBtn.classList.toggle("hidden", !selectionMode);
});

function fixEmoji(diaryId){
  const log = document.getElementById("chat-log");
  if(log){
    log.innerHTML += `<div><b>ë‚˜:</b> ë‹¤ì´ì–´ë¦¬(${diaryId})ì˜ ê°ì • ì´ëª¨ì§€ë¥¼ ë‹¤ì‹œ ë¶„ì„í•´ì¤˜</div>`;
  }
  fetch("{% url 'chatbot' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `message=${encodeURIComponent("ì´ ë‹¤ì´ì–´ë¦¬ ì´ëª¨ì§€ë¥¼ ë‹¤ì‹œ ë¶„ì„í•´ì¤˜")}&page=diary&provider=openai&model=gpt-4o-mini`
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.reply){
      if(log){ log.innerHTML += `<div><b>ì±—ë´‡:</b> ${d.reply}</div>`; }
      location.reload();
    }
  });
}
</script>

{% endblock %}
