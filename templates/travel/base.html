{% load static %}
<!doctype html>
<html lang="ko" data-theme="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Travel Companion{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='.9em' font-size='50'%3EğŸ§­%3C/text%3E%3C/svg%3E">
</head>
<body class="bg-slate-50 text-slate-900">

  <!-- í—¤ë” -->
  <header class="tg-header bg-gradient-to-r from-sky-600 to-indigo-600 text-white sticky top-0 z-50">
    <div class="max-w-[1400px] mx-auto px-4 py-4 flex items-center gap-3">
      <!-- ë©”ë‰´ ë²„íŠ¼ -->
      <button id="drawer-toggle"
              class="inline-flex items-center justify-center w-10 h-10 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/60"
              aria-controls="app-sidebar" aria-expanded="false" aria-label="ë©”ë‰´ ì—´ê¸°">
        <svg viewBox="0 0 24 24" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>

      <!-- ë¸Œëœë“œ -->
      <a href="/guide/" class="flex items-center gap-2 font-semibold text-lg">
        <span class="text-2xl">ğŸ§­</span> <span>Travel Companion</span>
      </a>

      <!-- ì˜¤ë¥¸ìª½: ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
      <div class="ml-auto flex items-center">
        <button id="theme-toggle"
                class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-white/15 hover:bg-white/25 focus:outline-none focus:ring-2 focus:ring-white/60"
                aria-label="ë‹¤í¬ ëª¨ë“œ í† ê¸€">ğŸŒ™</button>
      </div>
    </div>
  </header>

  <!-- ë°±ë“œë¡­ -->
  <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 backdrop-blur-[1px] hidden z-40"></div>

  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <aside id="app-sidebar"
         class="fixed left-0 top-0 h-screen w-72 max-w-[85vw] bg-white shadow-2xl z-50 transform -translate-x-full transition-transform duration-200 flex flex-col"
         aria-hidden="true" role="dialog" aria-label="ë‚´ë¹„ê²Œì´ì…˜" data-state="closed">
    <div class="px-4 py-3 border-b flex items-center gap-2">
      <strong class="text-slate-800">MENU</strong>
      <button id="drawer-close"
              class="ml-auto inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-slate-100"
              aria-label="ë©”ë‰´ ë‹«ê¸°">
        <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <nav class="p-3">
      <ul class="space-y-2">
        <li><a href="/guide/"     class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Guide</a></li>
        <li><a href="/photo/"     class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Photo</a></li>
        <li><a href="/translate/" class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Translate</a></li>
        <li><a href="/planner/"   class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Planner</a></li>
        <li><a href="/diary/"     class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Diary</a></li>
      </ul>
    </nav>
  </aside>

  <!-- ë³¸ë¬¸ -->
  <main class="max-w-[1400px] mx-auto px-4 py-6">
    {% block content %}{% endblock %}
  </main>

  <footer class="py-8 text-center text-slate-500">
    Â© {% now "Y" %} Travel Companion_UCUC
  </footer>

  <!-- âœ… ì „ì—­ ì±—ë´‡ -->
  <div id="chatbot-toggle" 
       class="fixed bottom-10 right-10 bg-indigo-600 text-white px-4 py-2 rounded-full shadow-lg cursor-pointer text-2xl">
    ğŸ’¬
  </div>

  <div id="chatbot-panel"
       class="hidden fixed bottom-20 right-6 w-96 bg-white border rounded-lg shadow-2xl flex flex-col z-50">
    <div class="flex items-center justify-between bg-indigo-600 text-white px-3 py-2 rounded-t-lg">
      <span>ChatBot</span>
      <button onclick="document.getElementById('chatbot-panel').classList.add('hidden')" class="text-sm">âœ–</button>
    </div>

    <!-- ëª¨ë¸ ì„ íƒ -->
    <div class="p-2 border-b flex gap-2">
      <select id="chat-provider" class="border rounded px-2 py-1 text-sm">
        <option value="openai">OpenAI</option>
        <option value="gemini">Gemini</option>
      </select>
      <select id="chat-model" class="border rounded px-2 py-1 text-sm">
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        <option value="gpt-4.1">gpt-4.1</option>
        <option value="gpt-4o">gpt-4o</option>
        <option value="gpt-5">gpt-5</option>
        <option value="gemini-1.5-flash">gemini-1.5-flash</option>
        <option value="gemini-1.5-pro">gemini-1.5-pro</option>
        <option value="gemini-1.5-flash-8b">gemini-1.5-flash-8b</option>
      </select>
    </div>

    <!-- ëŒ€í™” ë¡œê·¸ -->
    <div id="chat-log" class="p-3 h-64 overflow-y-auto text-sm"></div>

    <!-- ì…ë ¥ -->
    <div class="p-2 border-t flex gap-2">
      <input id="chat-input" class="flex-grow border rounded px-2 py-1 text-sm" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
      <button onclick="sendMessage()" class="bg-indigo-600 text-white px-3 py-1 rounded">ì „ì†¡</button>
    </div>
  </div>

  <!-- ë¡œë” -->
  <div id="loader"
       class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm"
       aria-live="polite" aria-label="Loading">
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="loader-card rounded-2xl shadow-2xl px-6 py-4 flex items-center gap-3">
        <svg class="animate-spin h-6 w-6 text-indigo-400" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <span class="font-semibold tracking-wide">Loading...</span>
      </div>
    </div>
  </div>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* í¼ ë¡œë” */
      document.querySelectorAll('form').forEach(f => {
        f.addEventListener('submit', () => {
          document.getElementById('loader')?.classList.remove('hidden');
          f.querySelectorAll('button, input[type=submit]').forEach(b => b.disabled = true);
        });
      });

      /* í˜„ì¬ ê²½ë¡œ í•˜ì´ë¼ì´íŠ¸ */
      const norm = p => (p || '/').replace(/\/+$/, '/');
      const path = norm(location.pathname);
      document.querySelectorAll('.drawer-link').forEach(a => {
        if (norm(a.getAttribute('href')) === path) {
          a.classList.add('bg-indigo-50','text-indigo-700','font-semibold','ring-1','ring-indigo-200');
          a.setAttribute('aria-current', 'page');
        }
      });

      /* ì‚¬ì´ë“œë°” í† ê¸€ */
      const drawer   = document.getElementById('app-sidebar');
      const backdrop = document.getElementById('drawer-backdrop');
      const openBtn  = document.getElementById('drawer-toggle');
      const closeBtn = document.getElementById('drawer-close');
      let lastFocused = null;

      function openDrawer() {
        lastFocused = document.activeElement;
        drawer.classList.remove('-translate-x-full');
        drawer.dataset.state = 'open';
        backdrop.classList.remove('hidden');
        openBtn.setAttribute('aria-expanded', 'true');
        drawer.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        setTimeout(() => drawer.querySelector('.drawer-link')?.focus(), 0);
        document.addEventListener('keydown', onKeyDown);
      }
      function closeDrawer() {
        drawer.classList.add('-translate-x-full');
        drawer.dataset.state = 'closed';
        backdrop.classList.add('hidden');
        openBtn.setAttribute('aria-expanded', 'false');
        drawer.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        document.removeEventListener('keydown', onKeyDown);
        lastFocused?.focus();
      }
      function onKeyDown(e) { if (e.key === 'Escape') { e.preventDefault(); closeDrawer(); } }
      openBtn?.addEventListener('click', () => drawer.dataset.state === 'open' ? closeDrawer() : openDrawer());
      closeBtn?.addEventListener('click', closeDrawer);
      backdrop?.addEventListener('click', closeDrawer);
      drawer.querySelectorAll('a').forEach(a => a.addEventListener('click', closeDrawer));

      /* ë‹¤í¬ëª¨ë“œ */
      const root = document.documentElement;
      const key  = 'tc_theme';
      const btn  = document.getElementById('theme-toggle');

      function applyTheme() {
        const saved = localStorage.getItem(key);
        if (saved === 'dark') root.setAttribute('data-theme','dark');
        else if (saved === 'light') root.removeAttribute('data-theme');
        else {
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) root.setAttribute('data-theme','dark');
          else root.removeAttribute('data-theme');
        }
        updateIcon();
      }
      function updateIcon() {
        const isDark = root.getAttribute('data-theme') === 'dark';
        btn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        btn.setAttribute('aria-label', isDark ? 'ë¼ì´íŠ¸ ëª¨ë“œ' : 'ë‹¤í¬ ëª¨ë“œ');
      }
      btn?.addEventListener('click', () => {
        const isDark = root.getAttribute('data-theme') === 'dark';
        if (isDark) { localStorage.setItem(key,'light'); root.removeAttribute('data-theme'); }
        else { localStorage.setItem(key,'dark'); root.setAttribute('data-theme','dark'); }
        updateIcon();
      });
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem(key)) {
          if (e.matches) root.setAttribute('data-theme','dark');
          else root.removeAttribute('data-theme');
          updateIcon();
        }
      });
      applyTheme();

      /* âœ… Enter ì…ë ¥ ì‹œ sendMessage() ì‹¤í–‰ */
      const chatInput = document.getElementById("chat-input");
      if (chatInput) {
        chatInput.addEventListener("keydown", function(e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });

    /* --- ì±—ë´‡ í•¨ìˆ˜ --- */
    document.getElementById("chatbot-toggle").onclick = () => {
      document.getElementById("chatbot-panel").classList.toggle("hidden");
    };

    function sendMessage() {
      const input    = document.getElementById("chat-input");
      const log      = document.getElementById("chat-log");
      const provider = document.getElementById("chat-provider").value;
      const model    = document.getElementById("chat-model").value;
      const msg      = input.value.trim();
      if (!msg) return;

      log.innerHTML += `<div><b>ë‚˜:</b> ${msg}</div>`;
      log.innerHTML += `<div id="chat-loading" class="text-gray-500">ì±—ë´‡: ë¡œë”©ì¤‘...</div>`;
      log.scrollTop = log.scrollHeight;
      input.value = "";

      fetch("{% url 'chatbot' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `message=${encodeURIComponent(msg)}&page={{ request.resolver_match.url_name }}&provider=${provider}&model=${model}`
      })
      .then(r => r.json())
      .then(d => {
        document.getElementById("chat-loading")?.remove();
        if (d.data) {
          log.innerHTML += `<div><b>ì±—ë´‡:</b> ê²°ê³¼ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤ </div>`;
          if ("{{ request.resolver_match.url_name }}" === "guide") {
            if (typeof updateGuideUI === "function") updateGuideUI(d.data);
          } else if ("{{ request.resolver_match.url_name }}" === "planner") {
            if (typeof updatePlannerUI === "function") updatePlannerUI(d.data);
          } else if ("{{ request.resolver_match.url_name }}" === "photo") {
            if (typeof updatePhotoUI === "function") updatePhotoUI(d.data);
          }
        } else if (d.reply) {
          log.innerHTML += `<div><b>ì±—ë´‡:</b> ${d.reply}</div>`;
        } else {
          log.innerHTML += `<div class="text-red-500"><b>ì—ëŸ¬:</b> ${d.error}</div>`;
        }
        log.scrollTop = log.scrollHeight;
      })
      .catch(err => {
        document.getElementById("chat-loading")?.remove();
        log.innerHTML += `<div class="text-red-500"><b>ì—ëŸ¬:</b> ${err}</div>`;
      });
    }
  </script>
</body>
</html>
