{% load static %}
<!doctype html>
<html lang="ko" data-theme="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Travel Companion{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='.9em' font-size='50'%3E🧭%3C/text%3E%3C/svg%3E">
</head>
<body class="bg-slate-50 text-slate-900">

  <!-- 헤더 -->
  <header class="tg-header bg-gradient-to-r from-sky-600 to-indigo-600 text-white sticky top-0 z-50">
    <div class="max-w-[1400px] mx-auto px-4 py-4 flex items-center gap-3">
      <!-- 메뉴 버튼 -->
      <button id="drawer-toggle"
              class="inline-flex items-center justify-center w-10 h-10 rounded-lg hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/60"
              aria-controls="app-sidebar" aria-expanded="false" aria-label="메뉴 열기">
        <svg viewBox="0 0 24 24" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>

      <!-- 브랜드 -->
      <a href="/guide/" class="flex items-center gap-2 font-semibold text-lg">
        <span class="text-2xl">🧭</span> <span>Travel Companion</span>
      </a>

      <!-- 오른쪽: 다크모드 토글 -->
      <div class="ml-auto flex items-center">
        <button id="theme-toggle"
                class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-white/15 hover:bg-white/25 focus:outline-none focus:ring-2 focus:ring-white/60"
                aria-label="다크 모드 토글">🌙</button>
      </div>
    </div>
  </header>

  <!-- 백드롭 -->
  <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 backdrop-blur-[1px] hidden z-40"></div>

  <!-- 좌측 사이드바 -->
  <aside id="app-sidebar"
         class="fixed left-0 top-0 h-screen w-72 max-w-[85vw] bg-white shadow-2xl z-50 transform -translate-x-full transition-transform duration-200 flex flex-col"
         aria-hidden="true" role="dialog" aria-label="내비게이션" data-state="closed">
    <div class="px-4 py-3 border-b flex items-center gap-2">
      <strong class="text-slate-800">MENU</strong>
      <button id="drawer-close"
              class="ml-auto inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-slate-100"
              aria-label="메뉴 닫기">
        <svg viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <nav class="p-3">
      <ul class="space-y-2">
        <li><a href="/guide/"     class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Guide</a></li>
        <li><a href="/photo/"     class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Photo</a></li>
        <li><a href="/translate/" class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Translate</a></li>
        <li><a href="/planner/"   class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Planner</a></li>
        <li><a href="/diary/"     class="drawer-link block px-3 py-2 rounded-lg text-slate-700 hover:bg-slate-100">Diary</a></li>
      </ul>
    </nav>
  </aside>

  <!-- 본문 -->
  <main class="max-w-[1400px] mx-auto px-4 py-6">
    {% block content %}{% endblock %}
  </main>

  <footer class="py-8 text-center text-slate-500">
    © {% now "Y" %} Travel Companion_UCUC
  </footer>

  <!-- ✅ 전역 챗봇 -->
  <div id="chatbot-toggle" 
       class="fixed bottom-10 right-10 bg-indigo-600 text-white px-4 py-2 rounded-full shadow-lg cursor-pointer text-2xl">
    💬
  </div>

  <div id="chatbot-panel"
       class="hidden fixed bottom-20 right-6 w-96 bg-white border rounded-lg shadow-2xl flex flex-col z-50">
    <div class="flex items-center justify-between bg-indigo-600 text-white px-3 py-2 rounded-t-lg">
      <span>ChatBot</span>
      <button onclick="document.getElementById('chatbot-panel').classList.add('hidden')" class="text-sm">✖</button>
    </div>

    <!-- 모델 선택 -->
    <div class="p-2 border-b flex gap-2">
      <select id="chat-provider" class="border rounded px-2 py-1 text-sm">
        <option value="openai">OpenAI</option>
        <option value="gemini">Gemini</option>
      </select>
      <select id="chat-model" class="border rounded px-2 py-1 text-sm">
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        <option value="gpt-4.1">gpt-4.1</option>
        <option value="gpt-4o">gpt-4o</option>
        <option value="gpt-5">gpt-5</option>
        <option value="gemini-1.5-flash">gemini-1.5-flash</option>
        <option value="gemini-1.5-pro">gemini-1.5-pro</option>
        <option value="gemini-1.5-flash-8b">gemini-1.5-flash-8b</option>
      </select>
    </div>

    <!-- 대화 로그 -->
    <div id="chat-log" class="p-3 h-64 overflow-y-auto text-sm"></div>

    <!-- 입력 -->
    <div class="p-2 border-t flex gap-2">
      <input id="chat-input" class="flex-grow border rounded px-2 py-1 text-sm" placeholder="메시지 입력" />
      <button onclick="sendMessage()" class="bg-indigo-600 text-white px-3 py-1 rounded">전송</button>
    </div>
  </div>

  <!-- 로더 -->
  <div id="loader"
       class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm"
       aria-live="polite" aria-label="Loading">
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="loader-card rounded-2xl shadow-2xl px-6 py-4 flex items-center gap-3">
        <svg class="animate-spin h-6 w-6 text-indigo-400" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <span class="font-semibold tracking-wide">Loading...</span>
      </div>
    </div>
  </div>

  <!-- 스크립트 -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* 폼 로더 */
      document.querySelectorAll('form').forEach(f => {
        f.addEventListener('submit', () => {
          document.getElementById('loader')?.classList.remove('hidden');
          f.querySelectorAll('button, input[type=submit]').forEach(b => b.disabled = true);
        });
      });

      /* 현재 경로 하이라이트 */
      const norm = p => (p || '/').replace(/\/+$/, '/');
      const path = norm(location.pathname);
      document.querySelectorAll('.drawer-link').forEach(a => {
        if (norm(a.getAttribute('href')) === path) {
          a.classList.add('bg-indigo-50','text-indigo-700','font-semibold','ring-1','ring-indigo-200');
          a.setAttribute('aria-current', 'page');
        }
      });

      /* 사이드바 토글 */
      const drawer   = document.getElementById('app-sidebar');
      const backdrop = document.getElementById('drawer-backdrop');
      const openBtn  = document.getElementById('drawer-toggle');
      const closeBtn = document.getElementById('drawer-close');
      let lastFocused = null;

      function openDrawer() {
        lastFocused = document.activeElement;
        drawer.classList.remove('-translate-x-full');
        drawer.dataset.state = 'open';
        backdrop.classList.remove('hidden');
        openBtn.setAttribute('aria-expanded', 'true');
        drawer.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        setTimeout(() => drawer.querySelector('.drawer-link')?.focus(), 0);
        document.addEventListener('keydown', onKeyDown);
      }
      function closeDrawer() {
        drawer.classList.add('-translate-x-full');
        drawer.dataset.state = 'closed';
        backdrop.classList.add('hidden');
        openBtn.setAttribute('aria-expanded', 'false');
        drawer.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        document.removeEventListener('keydown', onKeyDown);
        lastFocused?.focus();
      }
      function onKeyDown(e) { if (e.key === 'Escape') { e.preventDefault(); closeDrawer(); } }
      openBtn?.addEventListener('click', () => drawer.dataset.state === 'open' ? closeDrawer() : openDrawer());
      closeBtn?.addEventListener('click', closeDrawer);
      backdrop?.addEventListener('click', closeDrawer);
      drawer.querySelectorAll('a').forEach(a => a.addEventListener('click', closeDrawer));

      /* 다크모드 */
      const root = document.documentElement;
      const key  = 'tc_theme';
      const btn  = document.getElementById('theme-toggle');

      function applyTheme() {
        const saved = localStorage.getItem(key);
        if (saved === 'dark') root.setAttribute('data-theme','dark');
        else if (saved === 'light') root.removeAttribute('data-theme');
        else {
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) root.setAttribute('data-theme','dark');
          else root.removeAttribute('data-theme');
        }
        updateIcon();
      }
      function updateIcon() {
        const isDark = root.getAttribute('data-theme') === 'dark';
        btn.textContent = isDark ? '☀️' : '🌙';
        btn.setAttribute('aria-label', isDark ? '라이트 모드' : '다크 모드');
      }
      btn?.addEventListener('click', () => {
        const isDark = root.getAttribute('data-theme') === 'dark';
        if (isDark) { localStorage.setItem(key,'light'); root.removeAttribute('data-theme'); }
        else { localStorage.setItem(key,'dark'); root.setAttribute('data-theme','dark'); }
        updateIcon();
      });
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem(key)) {
          if (e.matches) root.setAttribute('data-theme','dark');
          else root.removeAttribute('data-theme');
          updateIcon();
        }
      });
      applyTheme();

      /* ✅ Enter 입력 시 sendMessage() 실행 */
      const chatInput = document.getElementById("chat-input");
      if (chatInput) {
        chatInput.addEventListener("keydown", function(e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });

    /* --- 챗봇 함수 --- */
    document.getElementById("chatbot-toggle").onclick = () => {
      document.getElementById("chatbot-panel").classList.toggle("hidden");
    };

    function sendMessage() {
      const input    = document.getElementById("chat-input");
      const log      = document.getElementById("chat-log");
      const provider = document.getElementById("chat-provider").value;
      const model    = document.getElementById("chat-model").value;
      const msg      = input.value.trim();
      if (!msg) return;

      log.innerHTML += `<div><b>나:</b> ${msg}</div>`;
      log.innerHTML += `<div id="chat-loading" class="text-gray-500">챗봇: 로딩중...</div>`;
      log.scrollTop = log.scrollHeight;
      input.value = "";

      fetch("{% url 'chatbot' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `message=${encodeURIComponent(msg)}&page={{ request.resolver_match.url_name }}&provider=${provider}&model=${model}`
      })
      .then(r => r.json())
      .then(d => {
        document.getElementById("chat-loading")?.remove();
        if (d.data) {
          log.innerHTML += `<div><b>챗봇:</b> 결과가 수정되었습니다 </div>`;
          if ("{{ request.resolver_match.url_name }}" === "guide") {
            if (typeof updateGuideUI === "function") updateGuideUI(d.data);
          } else if ("{{ request.resolver_match.url_name }}" === "planner") {
            if (typeof updatePlannerUI === "function") updatePlannerUI(d.data);
          } else if ("{{ request.resolver_match.url_name }}" === "photo") {
            if (typeof updatePhotoUI === "function") updatePhotoUI(d.data);
          }
        } else if (d.reply) {
          log.innerHTML += `<div><b>챗봇:</b> ${d.reply}</div>`;
        } else {
          log.innerHTML += `<div class="text-red-500"><b>에러:</b> ${d.error}</div>`;
        }
        log.scrollTop = log.scrollHeight;
      })
      .catch(err => {
        document.getElementById("chat-loading")?.remove();
        log.innerHTML += `<div class="text-red-500"><b>에러:</b> ${err}</div>`;
      });
    }
  </script>
</body>
</html>
