{% extends "travel/base.html" %}
{% block title %}Guide{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">📍도시 가이드 (여행 루트 추천)</h1>

<div class="grid md:grid-cols-3 gap-6">
  <section class="md:col-span-1">
    <!-- 모델 제공사/세부모델을 '폼 안'으로 이동 -->
    <form method="post" class="bg-white rounded-2xl shadow p-5 space-y-4">{% csrf_token %}
      <div>
        <label class="block text-sm font-medium mb-1">도시/지역명</label>
        <input name="city" value="Seoul" class="input" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">여행 일수</label>
        <input type="number" name="days" value="3" min="1" max="14" class="input" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">언어</label>
        <select name="lang" class="input">
          <option value="ko">한국어</option>
          <option value="en">English</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">관심사/제약</label>
        <input name="prefs" placeholder="야경, 카페, 미식 등" class="input" />
      </div>

      <!-- 모델 제공사 선택 -->
      <div>
        <label class="block text-sm font-medium mb-1">모델 제공사</label>
        <select name="provider" id="provider" class="input">
          <option value="openai" {% if provider == "openai" or not provider %}selected{% endif %}>OpenAI</option>
          <option value="gemini" {% if provider == "gemini" %}selected{% endif %}>Google Gemini</option>
        </select>
        <small class="muted">계정/시점에 따라 일부 모델은 미지원일 수 있어요.</small>
      </div>

      <!-- 세부 모델 선택 (제공사에 따라 자동 채움) -->
      <div>
        <label class="block text-sm font-medium mb-1">세부 모델</label>
        <select name="model" id="model" class="input"></select>

      </div>

      <button class="btn-primary w-full">루트 추천</button>
    </form>

    {% if error %}
      <div class="mt-4 bg-red-50 text-red-700 border border-red-200 rounded-xl p-4">
        <div class="font-semibold">오류</div>
        <div class="text-sm mt-1">{{ error }}</div>
      </div>
    {% endif %}
  </section>

  <section class="md:col-span-2 space-y-6" id="guide-result">

    {# ✅ 날씨 카드 (POST 후 보여줌) #}
    {% if weather %}
      <div class="bg-white rounded-2xl shadow p-4 flex items-center gap-4">
        <img src="{{ weather.icon_url }}" alt="{{ weather.desc }}" class="w-12 h-12">
        <div>
          <div class="font-semibold">{{ weather.name }} 현재 날씨</div>
          <div class="text-sm text-slate-600">
            {{ weather.desc }} · {{ weather.temp|floatformat:0 }}°C
            (체감 {{ weather.feels_like|floatformat:0 }}°)
          </div>
        </div>
        <div class="ml-auto text-sm text-slate-500">
          습도 {{ weather.humidity }}% · 바람 {{ weather.wind }} m/s
        </div>
      </div>
    {% elif weather_error %}
      <div class="bg-amber-50 text-amber-800 border border-amber-200 rounded-xl p-3 text-sm">
        날씨 정보를 가져오지 못했습니다. {{ weather_error }}
      </div>
    {% endif %}

    {% if result %}
      <div id="guide-ui">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">{{ result.city }} 추천 일정</h2>
          <form method="post" action="/guide/ics/">
            {% csrf_token %}
            <input type="hidden" name="city" value="{{ result.city }}">
            <button class="btn-secondary">📆 ICS 다운로드</button>
          </form>
        </div>

        <div class="space-y-5">
          {% for day in result.days %}
            <div class="bg-white rounded-2xl shadow overflow-hidden">
              <div class="px-5 py-4 border-b">
                <div class="text-sm text-slate-500">Day {{ day.day }}</div>
                <div class="text-lg font-semibold">{{ day.theme }}</div>
              </div>
              <div class="divide-y">
                {% for it in day.items %}
                  <div class="p-5 grid md:grid-cols-12 gap-4 items-start">
                    <div class="md:col-span-2">
                      <div class="text-sm font-medium text-indigo-700">{{ it.time_slot|default:"" }}</div>
                      <div class="text-xs text-slate-500">{{ it.area }}</div>
                    </div>
                    <div class="md:col-span-7">
                      <div class="font-semibold">{{ it.name }}</div>
                      <div class="text-sm text-slate-700 mt-1">{{ it.why }}</div>
                      {% if it.tips %}
                        <div class="text-xs mt-2 text-amber-700 bg-amber-50 inline-block px-2 py-1 rounded">TIP: {{ it.tips }}</div>
                      {% endif %}
                    </div>
                    <div class="md:col-span-3">
                      {% if it.thumb %}
                        <img src="{{ it.thumb }}" alt="{{ it.name }}" class="w-full h-24 object-cover rounded-xl">
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>

        <details class="bg-white rounded-2xl shadow p-5">
          <summary class="cursor-pointer font-semibold">원문 JSON 보기 (디버그용)</summary>
          <pre class="codeblock mt-3">{{ result.pretty_json }}</pre>
        </details>
      </div>
    {% else %}
      <div class="bg-white rounded-2xl shadow p-10 text-center text-slate-500">
        왼쪽 폼에 정보를 입력하고 <b>루트 추천</b>을 눌러주세요.
      </div>
    {% endif %}
  </section>
</div>

<!-- ✅ 모델 목록 채우는 스크립트 -->
<script>
  const SELECTED = {
    provider: "{{ provider|default:'openai' }}",
    model: "{{ model|default:'' }}"
  };

  const MODEL_CATALOG = {
    openai: ["gpt-4o-mini","gpt-4.1-mini","gpt-4.1","gpt-4o","gpt-5"],
    gemini: ["gemini-1.5-flash","gemini-1.5-pro","gemini-1.5-flash-8b"]
  };

  function fillModels() {
    const prov = document.getElementById('provider');
    const modelSel = document.getElementById('model');
    if (!prov || !modelSel) return;

    const list = MODEL_CATALOG[prov.value] || [];
    modelSel.innerHTML = "";
    list.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      if (SELECTED.provider === prov.value && SELECTED.model === m) opt.selected = true;
      modelSel.appendChild(opt);
    });
    if (!modelSel.value && list.length) modelSel.value = list[0];
  }

  document.addEventListener('DOMContentLoaded', () => {
    const prov = document.getElementById('provider');
    if (prov) {
      prov.addEventListener('change', () => { SELECTED.model = ""; fillModels(); });
      fillModels();
    }
  });

  /* ✅ 챗봇 결과 반영 함수 */
  function updateGuideUI(data){
    const box = document.getElementById("guide-result");
    if(!box) return;

    // 도시명
    let html = `
      <div id="guide-ui">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">${data.city || ''} 추천 일정</h2>
          <form method="post" action="/guide/ics/">
            {% csrf_token %}
            <input type="hidden" name="city" value="${data.city || ''}">
            <button class="btn-secondary">📆 ICS 다운로드</button>
          </form>
        </div>
    `;

    if(data.days){
      html += `<div class="space-y-5">`;
      data.days.forEach(day => {
        html += `
        <div class="bg-white rounded-2xl shadow overflow-hidden">
          <div class="px-5 py-4 border-b">
            <div class="text-sm text-slate-500">Day ${day.day}</div>
            <div class="text-lg font-semibold">${day.theme || ''}</div>
          </div>
          <div class="divide-y">`;
        (day.items || []).forEach(it => {
          html += `
            <div class="p-5 grid md:grid-cols-12 gap-4 items-start">
              <div class="md:col-span-2">
                <div class="text-sm font-medium text-indigo-700">${it.time_slot || ''}</div>
                <div class="text-xs text-slate-500">${it.area || ''}</div>
              </div>
              <div class="md:col-span-7">
                <div class="font-semibold">${it.name || ''}</div>
                <div class="text-sm text-slate-700 mt-1">${it.why || ''}</div>`;
          if(it.tips){
            html += `<div class="text-xs mt-2 text-amber-700 bg-amber-50 inline-block px-2 py-1 rounded">TIP: ${it.tips}</div>`;
          }
          html += `</div>
              <div class="md:col-span-3">`;
          if(it.thumb){
            html += `<img src="${it.thumb}" alt="${it.name}" class="w-full h-24 object-cover rounded-xl">`;
          }
          html += `</div></div>`;
        });
        html += `</div></div>`;
      });
      html += `</div>`;
    }

    // JSON 디버그
    html += `
      <details class="bg-white rounded-2xl shadow p-5 mt-10">
        <summary class="cursor-pointer font-semibold">원문 JSON 보기 (디버그용)</summary>
        <pre class="codeblock mt-3">${JSON.stringify(data, null, 2)}</pre>
      </details>
      </div>`;

    box.innerHTML = html;
  }
</script>
{% endblock %}
