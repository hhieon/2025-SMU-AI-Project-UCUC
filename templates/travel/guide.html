{% extends "travel/base.html" %}
{% block title %}Guide{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">ğŸ“ë„ì‹œ ê°€ì´ë“œ (ì—¬í–‰ ë£¨íŠ¸ ì¶”ì²œ)</h1>

<div class="grid md:grid-cols-3 gap-6">
  <section class="md:col-span-1">
    <!-- ëª¨ë¸ ì œê³µì‚¬/ì„¸ë¶€ëª¨ë¸ì„ 'í¼ ì•ˆ'ìœ¼ë¡œ ì´ë™ -->
    <form method="post" class="bg-white rounded-2xl shadow p-5 space-y-4">{% csrf_token %}
      <div>
        <label class="block text-sm font-medium mb-1">ë„ì‹œ/ì§€ì—­ëª…</label>
        <input name="city" value="Seoul" class="input" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">ì—¬í–‰ ì¼ìˆ˜</label>
        <input type="number" name="days" value="3" min="1" max="14" class="input" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">ì–¸ì–´</label>
        <select name="lang" class="input">
          <option value="ko">í•œêµ­ì–´</option>
          <option value="en">English</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">ê´€ì‹¬ì‚¬/ì œì•½</label>
        <input name="prefs" placeholder="ì•¼ê²½, ì¹´í˜, ë¯¸ì‹ ë“±" class="input" />
      </div>

      <!-- ëª¨ë¸ ì œê³µì‚¬ ì„ íƒ -->
      <div>
        <label class="block text-sm font-medium mb-1">ëª¨ë¸ ì œê³µì‚¬</label>
        <select name="provider" id="provider" class="input">
          <option value="openai" {% if provider == "openai" or not provider %}selected{% endif %}>OpenAI</option>
          <option value="gemini" {% if provider == "gemini" %}selected{% endif %}>Google Gemini</option>
        </select>
        <small class="muted">ê³„ì •/ì‹œì ì— ë”°ë¼ ì¼ë¶€ ëª¨ë¸ì€ ë¯¸ì§€ì›ì¼ ìˆ˜ ìˆì–´ìš”.</small>
      </div>

      <!-- ì„¸ë¶€ ëª¨ë¸ ì„ íƒ (ì œê³µì‚¬ì— ë”°ë¼ ìë™ ì±„ì›€) -->
      <div>
        <label class="block text-sm font-medium mb-1">ì„¸ë¶€ ëª¨ë¸</label>
        <select name="model" id="model" class="input"></select>

      </div>

      <button class="btn-primary w-full">ë£¨íŠ¸ ì¶”ì²œ</button>
    </form>

    {% if error %}
      <div class="mt-4 bg-red-50 text-red-700 border border-red-200 rounded-xl p-4">
        <div class="font-semibold">ì˜¤ë¥˜</div>
        <div class="text-sm mt-1">{{ error }}</div>
      </div>
    {% endif %}
  </section>

  <section class="md:col-span-2 space-y-6" id="guide-result">

    {# âœ… ë‚ ì”¨ ì¹´ë“œ (POST í›„ ë³´ì—¬ì¤Œ) #}
    {% if weather %}
      <div class="bg-white rounded-2xl shadow p-4 flex items-center gap-4">
        <img src="{{ weather.icon_url }}" alt="{{ weather.desc }}" class="w-12 h-12">
        <div>
          <div class="font-semibold">{{ weather.name }} í˜„ì¬ ë‚ ì”¨</div>
          <div class="text-sm text-slate-600">
            {{ weather.desc }} Â· {{ weather.temp|floatformat:0 }}Â°C
            (ì²´ê° {{ weather.feels_like|floatformat:0 }}Â°)
          </div>
        </div>
        <div class="ml-auto text-sm text-slate-500">
          ìŠµë„ {{ weather.humidity }}% Â· ë°”ëŒ {{ weather.wind }} m/s
        </div>
      </div>
    {% elif weather_error %}
      <div class="bg-amber-50 text-amber-800 border border-amber-200 rounded-xl p-3 text-sm">
        ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. {{ weather_error }}
      </div>
    {% endif %}

    {% if result %}
      <div id="guide-ui">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">{{ result.city }} ì¶”ì²œ ì¼ì •</h2>
          <form method="post" action="/guide/ics/">
            {% csrf_token %}
            <input type="hidden" name="city" value="{{ result.city }}">
            <button class="btn-secondary">ğŸ“† ICS ë‹¤ìš´ë¡œë“œ</button>
          </form>
        </div>

        <div class="space-y-5">
          {% for day in result.days %}
            <div class="bg-white rounded-2xl shadow overflow-hidden">
              <div class="px-5 py-4 border-b">
                <div class="text-sm text-slate-500">Day {{ day.day }}</div>
                <div class="text-lg font-semibold">{{ day.theme }}</div>
              </div>
              <div class="divide-y">
                {% for it in day.items %}
                  <div class="p-5 grid md:grid-cols-12 gap-4 items-start">
                    <div class="md:col-span-2">
                      <div class="text-sm font-medium text-indigo-700">{{ it.time_slot|default:"" }}</div>
                      <div class="text-xs text-slate-500">{{ it.area }}</div>
                    </div>
                    <div class="md:col-span-7">
                      <div class="font-semibold">{{ it.name }}</div>
                      <div class="text-sm text-slate-700 mt-1">{{ it.why }}</div>
                      {% if it.tips %}
                        <div class="text-xs mt-2 text-amber-700 bg-amber-50 inline-block px-2 py-1 rounded">TIP: {{ it.tips }}</div>
                      {% endif %}
                    </div>
                    <div class="md:col-span-3">
                      {% if it.thumb %}
                        <img src="{{ it.thumb }}" alt="{{ it.name }}" class="w-full h-24 object-cover rounded-xl">
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>

        <details class="bg-white rounded-2xl shadow p-5">
          <summary class="cursor-pointer font-semibold">ì›ë¬¸ JSON ë³´ê¸° (ë””ë²„ê·¸ìš©)</summary>
          <pre class="codeblock mt-3">{{ result.pretty_json }}</pre>
        </details>
      </div>
    {% else %}
      <div class="bg-white rounded-2xl shadow p-10 text-center text-slate-500">
        ì™¼ìª½ í¼ì— ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  <b>ë£¨íŠ¸ ì¶”ì²œ</b>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
    {% endif %}
  </section>
</div>

<!-- âœ… ëª¨ë¸ ëª©ë¡ ì±„ìš°ëŠ” ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  const SELECTED = {
    provider: "{{ provider|default:'openai' }}",
    model: "{{ model|default:'' }}"
  };

  const MODEL_CATALOG = {
    openai: ["gpt-4o-mini","gpt-4.1-mini","gpt-4.1","gpt-4o","gpt-5"],
    gemini: ["gemini-1.5-flash","gemini-1.5-pro","gemini-1.5-flash-8b"]
  };

  function fillModels() {
    const prov = document.getElementById('provider');
    const modelSel = document.getElementById('model');
    if (!prov || !modelSel) return;

    const list = MODEL_CATALOG[prov.value] || [];
    modelSel.innerHTML = "";
    list.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      if (SELECTED.provider === prov.value && SELECTED.model === m) opt.selected = true;
      modelSel.appendChild(opt);
    });
    if (!modelSel.value && list.length) modelSel.value = list[0];
  }

  document.addEventListener('DOMContentLoaded', () => {
    const prov = document.getElementById('provider');
    if (prov) {
      prov.addEventListener('change', () => { SELECTED.model = ""; fillModels(); });
      fillModels();
    }
  });

  /* âœ… ì±—ë´‡ ê²°ê³¼ ë°˜ì˜ í•¨ìˆ˜ */
  function updateGuideUI(data){
    const box = document.getElementById("guide-result");
    if(!box) return;

    // ë„ì‹œëª…
    let html = `
      <div id="guide-ui">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">${data.city || ''} ì¶”ì²œ ì¼ì •</h2>
          <form method="post" action="/guide/ics/">
            {% csrf_token %}
            <input type="hidden" name="city" value="${data.city || ''}">
            <button class="btn-secondary">ğŸ“† ICS ë‹¤ìš´ë¡œë“œ</button>
          </form>
        </div>
    `;

    if(data.days){
      html += `<div class="space-y-5">`;
      data.days.forEach(day => {
        html += `
        <div class="bg-white rounded-2xl shadow overflow-hidden">
          <div class="px-5 py-4 border-b">
            <div class="text-sm text-slate-500">Day ${day.day}</div>
            <div class="text-lg font-semibold">${day.theme || ''}</div>
          </div>
          <div class="divide-y">`;
        (day.items || []).forEach(it => {
          html += `
            <div class="p-5 grid md:grid-cols-12 gap-4 items-start">
              <div class="md:col-span-2">
                <div class="text-sm font-medium text-indigo-700">${it.time_slot || ''}</div>
                <div class="text-xs text-slate-500">${it.area || ''}</div>
              </div>
              <div class="md:col-span-7">
                <div class="font-semibold">${it.name || ''}</div>
                <div class="text-sm text-slate-700 mt-1">${it.why || ''}</div>`;
          if(it.tips){
            html += `<div class="text-xs mt-2 text-amber-700 bg-amber-50 inline-block px-2 py-1 rounded">TIP: ${it.tips}</div>`;
          }
          html += `</div>
              <div class="md:col-span-3">`;
          if(it.thumb){
            html += `<img src="${it.thumb}" alt="${it.name}" class="w-full h-24 object-cover rounded-xl">`;
          }
          html += `</div></div>`;
        });
        html += `</div></div>`;
      });
      html += `</div>`;
    }

    // JSON ë””ë²„ê·¸
    html += `
      <details class="bg-white rounded-2xl shadow p-5 mt-10">
        <summary class="cursor-pointer font-semibold">ì›ë¬¸ JSON ë³´ê¸° (ë””ë²„ê·¸ìš©)</summary>
        <pre class="codeblock mt-3">${JSON.stringify(data, null, 2)}</pre>
      </details>
      </div>`;

    box.innerHTML = html;
  }
</script>
{% endblock %}
