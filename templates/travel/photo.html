{% extends "travel/base.html" %}
{% block title %}Photo{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">ğŸ“¸ì‚¬ì§„ ì¥ì†Œ (ì—…ë¡œë“œ â†’ ì¥ì†Œ ì‹ë³„)</h1>

<div class="grid md:grid-cols-3 gap-6">
  <section class="md:col-span-1">
    <form method="post" enctype="multipart/form-data" class="bg-white rounded-2xl shadow p-5 space-y-4">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium mb-1">ë„ì‹œ íŒíŠ¸ (ì„ íƒ)</label>
        <input name="city_hint" class="input" placeholder="ì˜ˆ: Seoul / Tokyo" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">êµ­ê°€ íŒíŠ¸ (ì„ íƒ)</label>
        <input name="country_hint" class="input" placeholder="ì˜ˆ: South Korea / Japan" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">ìµœëŒ€ í›„ë³´ ìˆ˜</label>
        <input type="number" name="topk" value="3" min="1" max="5" class="input" />
      </div>

      <!-- ğŸ”’ í˜„ì¬ ë©€í‹°ëª¨ë‹¬ì€ OpenAI Vision ê³ ì • -->
      <div>
        <label class="block text-sm font-medium mb-1">ëª¨ë¸ ì œê³µì‚¬</label>
        <select class="input" disabled>
          <option selected>OpenAI (Vision)</option>
        </select>
        <small class="muted">ì‚¬ì§„ ì¸ì‹ì€ í˜„ì¬ OpenAI Vision ì „ìš© ì—”ì§„ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</small>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">ì„¸ë¶€ ëª¨ë¸</label>
        <select class="input" disabled>
          <option selected>gpt-4o / gpt-4o-mini (vision)</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">ì‚¬ì§„</label>
        <input type="file" name="photo" accept="image/*" required class="block w-full text-sm" />
      </div>
      <button class="btn-primary w-full">ì‹ë³„í•˜ê¸°</button>
    </form>

    {% if error %}
      <div class="mt-4 bg-red-50 text-red-700 border border-red-200 rounded-xl p-4">
        <div class="font-semibold">ì˜¤ë¥˜</div>
        <div class="text-sm mt-1">{{ error }}</div>
      </div>
      {% if raw %}<pre class="codeblock mt-2">{{ raw }}</pre>{% endif %}
    {% endif %}
  </section>

  <section class="md:col-span-2 space-y-6" id="photo-result">
    {% if result %}
      <div class="bg-white rounded-2xl shadow p-5 overflow-auto">
        <h3 class="font-semibold mb-3">í›„ë³´ ëª©ë¡</h3>
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-600">
            <tr><th class="py-2">ì¥ì†Œ</th><th>ë„ì‹œ</th><th>êµ­ê°€</th><th>ìœ í˜•</th><th>ì‹ ë¢°ë„</th><th>ê·¼ê±°</th></tr>
          </thead>
          <tbody class="divide-y">
            {% for c in result.cands %}
              <tr class="hover:bg-slate-50">
                <td class="py-2">{{ c.name }}</td>
                <td>{{ c.city }}</td>
                <td>{{ c.country }}</td>
                <td>{{ c.type }}</td>
                <td>{{ c.confidence }}</td>
                <td class="max-w-[28rem]">{{ c.reasons }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="bg-white rounded-2xl shadow p-5">
        <h4 class="font-semibold mb-2">ê°€ì¥ ìœ ë ¥: {{ result.place }}</h4>
        {% if result.ref_url %}
          <img src="{{ result.ref_url }}" class="w-full max-h-80 object-cover rounded-xl">
        {% else %}
          <div class="text-slate-500">ì°¸ê³  ì´ë¯¸ì§€ ì—†ìŒ</div>
        {% endif %}
      </div>

      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-semibold mb-2">ğŸ’¬ ì‚¬ì§„ ê¸°ë°˜ Q&A</h3>
        <form method="post" action="/photo/ask/" class="flex gap-3">
          {% csrf_token %}
          <input name="question" placeholder="ì˜ˆ: ì •í™•í•œ ìœ„ì¹˜/ì…ì¥ì‹œê°„/ì´¬ì˜ í¬ì¸íŠ¸ ë“±" class="input flex-1" />
          <button class="btn-secondary">ì§ˆë¬¸í•˜ê¸°</button>
        </form>
      </div>
    {% else %}
      <div class="bg-white rounded-2xl shadow p-10 text-center text-slate-500">
        ì™¼ìª½ì—ì„œ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ ì¥ì†Œë¥¼ ì‹ë³„í•´ë³´ì„¸ìš”.
      </div>
    {% endif %}

    {% if qa_answer %}
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-semibold mb-2">ë‹µë³€</h3>
        <div class="prose max-w-none">{{ qa_answer }}</div>
      </div>
    {% endif %}
  </section>
</div>

<!-- âœ… ì±—ë´‡ ê²°ê³¼ ë°˜ì˜ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  function updatePhotoUI(data){
    const box = document.getElementById("photo-result");
    if(!box) return;
    box.innerHTML = `<pre class="codeblock mt-3">${JSON.stringify(data, null, 2)}</pre>`;
  }
</script>
{% endblock %}
